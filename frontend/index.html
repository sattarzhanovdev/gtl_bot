<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GTL — Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b11; --bg-2:#1c1c25; --card:#26252f; --txt:#e9ecff; --muted:#9aa0b3;
      --neon:#ff3bd3; --neon-2:#7a7cff; --ok:#39ff88; --warn:#ffcc00;
      --radius:22px; --r:16px; --gap:14px; --shadow:0 0 0 2px #ff3bd344, 0 0 22px #ff3bd333;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt); background:
        radial-gradient(1200px 900px at 50% -10%, #23214a 0%, var(--bg) 55%) fixed;
      font-family:"Inter", system-ui, Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* layout */
    .wrap{min-height:100dvh; padding-bottom:92px}
    .container{max-width:880px;margin:0 auto;padding:16px}
    .row{display:flex;align-items:center;gap:10px}
    .space{flex:1}
    .card{background:var(--card);border-radius:var(--radius);padding:16px}

    /* header */
    .header{padding:16px}
    .username{font-family:"Chakra Petch", monospace; font-weight:700; font-size:28px;
      background:linear-gradient(90deg,#fff,#c8d0ff); -webkit-background-clip:text; color:transparent}
    .stats{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-top:14px}
    .stats .tile{background:var(--bg-2);border-radius:18px;padding:16px}
    .h-label{color:var(--muted);font-weight:600;letter-spacing:.3px}
    .balance{font-family:"Chakra Petch", monospace; font-size:34px;margin-top:8px}

    /* sections */
    .section{margin-top:18px}
    .section h2{margin:0 0 10px;font-size:20px}
    .levels .hero{
      position:relative; border-radius:24px; overflow:hidden;
      background:linear-gradient(120deg,#281b5c,#fe3bd41a), url('https://images.unsplash.com/photo-1618172193763-39e4d94dfd4b?q=80&w=1600&auto=format&fit=crop') center/cover;
      height:190px; display:flex; align-items:flex-end; padding:16px;
      box-shadow:0 6px 18px #00000055;
    }
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:2px solid #ffffff26;border-radius:14px;background:#ffffff10}
    .pill .el{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;font-weight:800;background:
      radial-gradient(#ff69f3,#4d3cff)}
    .play{position:absolute;right:14px;bottom:14px;padding:12px 18px;border-radius:16px;background:#000000aa;border:2px solid var(--neon);color:#fff;font-weight:800;box-shadow:var(--shadow)}
    .play[disabled]{opacity:.5;filter:grayscale(1)}

    /* shop */
    .shop .group{margin-top:12px}
    .entry{display:flex;gap:12px;align-items:center;justify-content:space-between;background:var(--bg-2);
      padding:12px;border-radius:16px}
    .entry .left{display:flex;gap:12px;align-items:center}
    .ico{width:54px;height:54px;border-radius:16px;background:#ffffff10;display:grid;place-items:center;
      box-shadow:inset 0 0 0 2px #ffffff14}
    .btn{background:#ffffff14;border:0;border-radius:14px;color:#fff;padding:10px 14px}
    .btn.primary{background:linear-gradient(90deg,var(--neon),var(--neon-2));font-weight:700;box-shadow:var(--shadow)}

    /* finance/social */
    .tile.neon{box-shadow:var(--shadow);border:2px solid #ffffff22}
    .social .entry{border:2px solid var(--neon);box-shadow:var(--shadow)}

    /* periodic table */
    .ptable .grid{display:grid;grid-template-columns:repeat(18, 1fr);gap:6px}
    .cell{aspect-ratio:1;border-radius:10px;background:#1b1b2e;display:flex;align-items:center;justify-content:center}
    .cell.ok{background:#1ed760}
    .legend{display:flex;gap:8px;margin:10px 0 0;color:#cfd3e6}
    .legend div{display:flex;gap:6px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}

    /* navbar */
    .nav{position:fixed;left:0;right:0;bottom:0;background:#0b0b12f2;backdrop-filter:blur(8px);
      padding:10px 14px; display:grid;grid-template-columns:repeat(5,1fr);gap:10px; border-top:1px solid #ffffff10}
    .nav button{height:62px;border-radius:18px;background:#ffffff0f;border:2px solid #ffffff14;color:#fff}
    .nav button.active{outline:0; box-shadow:0 0 0 3px #ff3bd355,0 0 26px #ff3bd333; border-color:var(--neon)}
    .nav svg{width:26px;height:26px}

    /* helpers */
    .hide{display:none}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="username" id="username">username</div>
      <div class="stats">
        <div class="tile row">
          <div class="space">
            <div class="h-label">Account balance</div>
            <div class="balance" id="balance">0 GTL</div>
          </div>
          <div style="width:1px;background:#ffffff18;align-self:stretch"></div>
          <div style="width:120px;text-align:center">
            <div class="h-label">Level</div>
            <div class="balance" id="level" style="font-size:36px">1</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LEVELS -->
    <div class="section levels">
      <h2>Levels</h2>
      <div class="hero">
        <div class="pill">
          <div class="el">Br</div>
          <div class="el">Au</div>
          <div class="el" style="box-shadow:var(--shadow)">C</div>
          <div class="el">Fe</div>
        </div>
        <div style="position:absolute;left:18px;bottom:66px;font-size:24px;font-weight:800">Базовый уровень</div>
        <button class="play" id="playBtn">Play</button>
      </div>
    </div>

    <!-- SHOP -->
    <div class="section shop">
      <h2>Shop</h2>
      <div class="card group">
        <div class="h-label" style="margin-bottom:8px">Boost Cards</div>
        <div id="boostList">
          <!-- заполнится из /shop/items -->
        </div>
      </div>

      <div class="card group">
        <div class="h-label" style="margin-bottom:8px">Mineral Cards</div>
        <div id="mineralList">
          <!-- демо карточки -->
        </div>
      </div>
    </div>

    <!-- FINANCE / SOCIAL -->
    <div class="section finance">
      <h2>Join Us</h2>
      <div class="card social">
        <div class="entry" style="margin-bottom:10px">
          <div class="left">
            <div class="ico">f</div>
            <div><div style="font-weight:700">Follow GTL on Facebook</div><div class="muted">+500 GTL</div></div>
          </div>
          <button class="btn primary">Open</button>
        </div>
        <div class="entry" style="margin-bottom:10px">
          <div class="left">
            <div class="ico">X</div>
            <div><div style="font-weight:700">Follow GTL on X</div><div class="muted">+500 GTL</div></div>
          </div>
          <button class="btn primary">Open</button>
        </div>
        <div class="entry">
          <div class="left">
            <div class="ico">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 2c-2.8 0-3.2.01-4.3.06-1.1.05-1.9.23-2.6.49a5.2 5.2 0 0 0-1.9 1.24A5.2 5.2 0 0 0 1 5.8c-.26.7-.44 1.5-.49 2.6C.46 9.5.45 9.9.45 12s.01 2.5.06 3.6c.05 1.1.23 1.9.49 2.6.29.8.68 1.4 1.24 1.9.55.55 1.1.95 1.9 1.24.7.26 1.5.44 2.6.49 1.1.05 1.5.06 3.6.06s2.5-.01 3.6-.06c1.1-.05 1.9-.23 2.6-.49a5.2 5.2 0 0 0 1.9-1.24 5.2 5.2 0 0 0 1.24-1.9c.26-.7.44-1.5.49-2.6.05-1.1.06-1.5.06-3.6s-.01-2.5-.06-3.6c-.05-1.1-.23-1.9-.49-2.6a5.2 5.2 0 0 0-1.24-1.9 5.2 5.2 0 0 0-1.9-1.24c-.7-.26-1.5-.44-2.6-.49C15.2 2.01 14.8 2 12 2Z" stroke="#fff" opacity=".25"/><circle cx="12" cy="12" r="5.5" fill="#fff" opacity=".07"/></svg>
            </div>
            <div><div style="font-weight:700">Follow GTL on Instagram</div><div class="muted">+500 GTL</div></div>
          </div>
          <button class="btn primary">Open</button>
        </div>
      </div>
    </div>

    <!-- FRIENDS -->
    <div class="section friends">
      <h2>Invite friends</h2>
      <div class="card tile neon">
        <div style="font-weight:700;font-size:18px;margin-bottom:8px">Invite a friend!</div>
        <div class="muted" style="margin-bottom:12px">Receive <b>+1,000$</b> for every invited friend</div>
        <button class="btn primary" id="inviteBtn">Invite Friends</button>
      </div>
    </div>

    <!-- PERIODIC TABLE -->
    <div class="section ptable">
      <h2 style="color:var(--neon)">Периодическая таблица</h2>
      <div class="muted" id="ptCounter" style="margin-bottom:10px">Собрано элементов: 0 из 118</div>
      <div class="card">
        <div class="grid" id="ptGrid"></div>
        <div class="legend">
          <div><span class="dot" style="background:#1ed760"></span> Собрано</div>
          <div><span class="dot" style="background:#2b2e45"></span> Нет</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NAVBAR -->
<div class="nav" id="nav">
  <button data-tab="home" class="active" aria-label="Home">
    <svg viewBox="0 0 24 24" fill="none"><path d="M3 9.5 12 3l9 6.5v10a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 19.5V9.5Z" stroke="#fff" opacity=".9"/></svg>
  </button>
  <button data-tab="shop" aria-label="Shop">
    <svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18l-2 12H5L3 7Zm4-4h10l2 4H5l2-4Z" stroke="#fff" opacity=".9"/></svg>
  </button>
  <button data-tab="finance" aria-label="Finance">
    <svg viewBox="0 0 24 24" fill="none"><path d="M4 18h16M6 14v4m4-8v8m4-5v5m4-10v10" stroke="#fff" opacity=".9"/></svg>
  </button>
  <button data-tab="friends" aria-label="Friends">
    <svg viewBox="0 0 24 24" fill="none"><path d="M8.5 12a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm7 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM2.5 20.5a6 6 0 0 1 12 0M13 20.5a5 5 0 0 1 9-3" stroke="#fff" opacity=".9"/></svg>
  </button>
  <button data-tab="ptable" aria-label="Table">
    <svg viewBox="0 0 24 24" fill="none"><path d="M3 3h8v8H3V3Zm10 0h8v8h-8V3ZM3 13h8v8H3v-8Zm10 0h8v8h-8v-8Z" stroke="#fff" opacity=".9"/></svg>
  </button>
</div>

<script>
  const tg = window.Telegram.WebApp; tg.ready();
  const BASE = "/api";
  let JWT=null, PROFILE=null;

  
  function $(q){return document.querySelector(q)}
  function api(path, method='GET', body){
    return fetch(BASE+path,{
      method, headers:{'Content-Type':'application/json', ...(JWT?{Authorization:'Bearer '+JWT}:{})},
      body: body?JSON.stringify(body):undefined
    }).then(async r=>{ if(!r.ok) throw new Error(await r.text()); return r.json(); });
  }


  (async function auth(){
    try {
      const r = await fetch("/api/auth/telegram-webapp", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ initData: tg.initData })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || r.statusText);

      localStorage.setItem("jwt", data.jwt);
      // обновление UI
      document.querySelector("#username").textContent =
        data.profile.username || data.profile.display_name || "player";
      document.querySelector("#balance").textContent = (data.profile.total_gtl ?? 0) + " GTL";
      document.querySelector("#level").textContent = data.profile.level ?? 1;
    } catch (e) {
      alert("Auth error: " + e.message);
    }
  })();

  function paintHeader(){
    $('#username').textContent = PROFILE.username || PROFILE.display_name || 'player';
    $('#balance').textContent = (PROFILE.total_gtl.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})) + ' GTL';
    $('#level').textContent = PROFILE.level || 1;
    // если нет стартового набора — подсказка
    const playBtn = $('#playBtn');
    playBtn.disabled = !PROFILE.has_starter_pack && PROFILE.level===1;
    playBtn.textContent = playBtn.disabled ? 'Buy to Play' : 'Play';
  }

  /* -------- LEVELS / GAME -------- */
  let SESSION=null;
  $('#playBtn').onclick = async ()=>{
    const s = await api('/game/start','POST'); SESSION=s;
    // в прототипе просто имитируем быструю игру и завершение
    setTimeout(async ()=>{
      const payload = { total_gtl: 137, minerals: {H:3, He:1, C:4}, clicks_per_sec: 12.3 };
      await api(`/game/finish/${SESSION.id}`,'POST',{payload});
      PROFILE = await api('/me'); paintHeader();
      alert(`Insane! You earned ${payload.total_gtl} GTL`);
      loadPeriodic();
    }, Math.min((s.duration_sec||10)*1000, 2500)); // короткая демо-задержка
  };

  /* -------- SHOP -------- */
  async function loadShop(){
    const {items} = await api('/shop/items');
    const boost = items.map(i=>`
      <div class="entry" style="margin-bottom:8px">
        <div class="left">
          <div class="ico">⚡</div>
          <div>
            <div style="font-weight:700">${i.title}</div>
            <div class="muted">${i.price} ⟡</div>
          </div>
        </div>
        <button class="btn primary" onclick="buy('${i.key}')">Buy</button>
      </div>`).join('');
    document.getElementById('boostList').innerHTML = boost;

    // демо минералы
    document.getElementById('mineralList').innerHTML = `
      <div class="entry" style="margin-bottom:8px">
        <div class="left"><img class="ico" src="https://images.unsplash.com/photo-1616512651849-5f3f1f5f41a5?q=80&w=300&auto=format&fit=crop" alt="C"/>
          <div><div style="font-weight:700">Mineral 1</div><div class="muted">Owned: 1</div></div></div>
        <button class="btn">View</button>
      </div>
      <div class="entry">
        <div class="left"><img class="ico" src="https://images.unsplash.com/photo-1616401784845-180882ba9a4d?q=80&w=300&auto=format&fit=crop" alt="Au"/>
          <div><div style="font-weight:700">Mineral 2</div><div class="muted">Owned: 1</div></div></div>
        <button class="btn">View</button>
      </div>`;
  }
  async function buy(key){
    try{
      const r = await api('/shop/buy','POST',{item_key:key});
      PROFILE=r.profile; paintHeader();
    }catch(e){ alert('Not enough balance');}
  }

  /* -------- REFERRALS -------- */
  $('#inviteBtn').onclick = async ()=>{
    const r = await api('/referral');
    await navigator.clipboard.writeText(r.link);
    alert('Referral link copied: ' + r.link);
  };

  /* -------- PERIODIC TABLE -------- */
  const PT = ["H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn",
              "Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe",
              "Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu",
              "Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn",
              "Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr",
              "Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"];
  function paintPT(collected){
    const grid = $('#ptGrid'); grid.innerHTML='';
    let gotCount=0;
    PT.forEach(sym=>{
      const c = document.createElement('div');
      c.className='cell'+(collected?.[sym]>0?' ok':'');
      if(collected?.[sym]>0) gotCount++;
      c.innerHTML = `<div style="text-align:center;font-weight:800">${sym}</div>`;
      grid.appendChild(c);
    });
    $('#ptCounter').textContent = `Собрано элементов: ${gotCount} из 118`;
  }
  async function loadPeriodic(){
    try{
      const d = await api('/periodic');
      paintPT(d.collected||{});
    }catch(e){ paintPT({}); }
  }

  /* -------- TAB ROUTER (нижняя навигация) -------- */
  const sections = {
    home: ['.levels','.friends'],     // домашний: уровни + друзья-блок
    shop: ['.shop'],
    finance: ['.finance'],
    friends: ['.friends'],
    ptable: ['.ptable']
  };
  function showTab(tab){
    // switch active
    document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    // hide/show sections
    document.querySelectorAll('.section').forEach(s=>s.classList.add('hide'));
    (sections[tab]||[]).forEach(sel=>document.querySelector(sel).classList.remove('hide'));
  }
  document.querySelectorAll('.nav button').forEach(btn=>{
    btn.onclick = ()=> showTab(btn.dataset.tab);
  });

  /* -------- BOOTSTRAP -------- */
  (async()=>{
    await auth();
    await loadShop();
    await loadPeriodic();
    showTab('home'); // стартовая вкладка
  })();
</script>
</body>
</html>